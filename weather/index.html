<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Weather</title>
</head>

<body>
    <div class="container">
        <div class="input">
            <form onsubmit="mySubmit(event)">
                <div class="autocomplete">
                    <input placeholder="Enter Ñity" class="main-input" autocomplete="off">
                    <button class="main-but" id="getWeatherBut">></button>

                    <div class="line"></div>
                </div>
            </form>
        </div>
        <div id="response"></div>
    </div>

    <script>
        var kinput = document.getElementsByClassName('main-input')[0];
        var line = document.getElementsByClassName('line')[0];

        function mySubmit(e) {
            e.preventDefault();
            fetchApi();
        }

        function loadCookie() {
            kinput.value = getCookie('city') ? getCookie('city') : '';
        }

        function getReq() {
            if (getCookie('city')) {
                fetchApi();
            }
        }

        function setColor() {
            if (kinput.onfocus = function () {
                line.style.borderColor = 'grey';
            });

            if (kinput.onblur = function () {
                line.style.borderColor = '#f1f1f1';
            });
        }

        loadCookie();
        getReq();
        setColor();

        function fetchApi() {
            var city = kinput.value;
            var key = "&appid=1ffca6db0ea908d8883ff72a55ebaf21";
            var metric = '&units=metric';
            var blocknum = city.replace(/^([^0-9]*)$/);
            var divresp = document.getElementById("response");
            var date = new Date();

            setCookie('city', city);

            if (city == 0 || city == blocknum) {
                return divresp.innerHTML = "";
            }

            else {
                fetch("https://api.openweathermap.org/data/2.5/weather?q=" + city + key + metric)
                    .then(response => response.json())

                    .then(data => {
                        var textParse;

                        if (data.sys) {
                            textParse = `<div>${date.getHours()}:${date.getMinutes()}</div>
                            <div>${data.weather[0].main}</div>
                            <div>${data.main.temp}&deg;</div> <div>${data.wind.speed} m/s</div>`;

                            divresp.innerHTML = textParse;
                        }

                        else {
                            switch (data.cod) {
                                case '400':
                                    textParse = `<div>Bad request</div>`;

                                    divresp.innerHTML = textParse;
                                    break;

                                case '404':
                                    textParse = `<div>Sorry, there is no such city in our database</div>`;
                                    divresp.innerHTML = textParse;
                                    break;

                                default:
                                    textParse = `<div>${data.message}</div>`;
                                    break;
                            }
                        }
                    })

                    .catch(error => {
                        // const errorStatus = `<div>${error.cod}: ${error.message}</div>`;
                        // document.getElementById('response').innerHTML = errorStatus;
                        console.log(error);
                    });
            }
        };

        function getCookie(name) {
            var matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
            ));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        function setCookie(name, value, options) {
            options = options || {};

            var expires = options.expires;

            if (typeof expires == "number" && expires) {
                var d = new Date();
                d.setTime(d.getTime() + expires * 1000);
                expires = options.expires = d;
            }
            if (expires && expires.toUTCString) {
                options.expires = expires.toUTCString();
            }

            value = encodeURIComponent(value);

            var updatedCookie = name + "=" + value;

            for (var propName in options) {
                updatedCookie += "; " + propName;
                var propValue = options[propName];
                if (propValue !== true) {
                    updatedCookie += "=" + propValue;
                }
            }

            document.cookie = updatedCookie;
        }

        /* This is XMLHttpRequest
        function stockApi() {
            var city = document.getElementById('city').value;
            var key = "1ffca6db0ea908d8883ff72a55ebaf21";
            var x = new XMLHttpRequest();

            x.open('GET', 'https://api.openweathermap.org/data/2.5/weather?q=' + city + '&appid=' + key + '&units=metric', true);
            x.send();

            x.onreadystatechange = function () {
                if (x.readyState === 4) {
                    if (x.status >= 200 && x.status < 400) {
                        // Success!
                        var mass = JSON.parse(x.responseText);

                        const textParse = `<div>Country: ${mass.sys.country}</div>
                        <div>City: ${mass.name}</div> <div>Weather: ${mass.weather[0].main}</div>
                        <div>Temperature: ${mass.main.temp}</div> <div>Wind speed: ${mass.wind.speed} m/s</div>`;

                        document.getElementById('response').innerHTML = textParse;
                    }

                    else {
                        const error = `<div>${x.status}: ${x.statusText}</div>`;
                        document.getElementById('response').innerHTML = error;
                    }
                }

                else return;
            }
        };
        */
    </script>
</body>

</html>